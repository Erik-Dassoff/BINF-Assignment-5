---
title: "Functional Enrichment Analysis of Sex-specific Muscle Transcriptome from Sedentary,
  Strength-Trained, or Endurance-Trained Participants"
author: "Erik Dassoff"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "Result", warning = FALSE, message = FALSE)

```

Attributions:

# Part 1: Data Acquisition, Exploration, Filtering, and Quality Control

```{r, Part1, fig.height=15}
#loading libraries----
library(readxl)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(data.table)
#BiocManager::install('EnhancedVolcano')
library(EnhancedVolcano)
library(gridExtra)
library(pathfindR)
library(microbenchmark)
library(utils)

#setting adjustable parameters----
#p-value for statistical significance, considering p-value already adjusted for false discovery rate. 0.05 is selected to consider a level of statistical significance that limits the false discovery rate of all significant results to less than 5%.
pCutoff <- 0.05

#cutoff for fold change for volcano plots. Two is selected to highlight reasonably large differentially expressed genes that are likely to have high biological relevance.
FCcutoff <- 2

#p-value cutoff for significant enrichment. 0.05 selected as a standard level and to not be overly exclusive.
enrichThresh <- 0.05

#adjustment method for enrichment analysis (i.e., bonferroni or fdr). Using fdr to be consistent with differential expression analysis.
adjMethod <- "fdr"

#number of iterations for protein sub-network search. Start with ten and increase for greater coverage of functional pathways.
iterations <- 10

#gene set for enrichment analysis (choose from: "Kegg", "Reactome", "BioCarta", "GO-all", "Go-BP", "GO-CC", "GO-MF", "cell_markers", "mmu_KEGG"). Starting with KEGG, because it contains biological pathways of interest with good interpretability.
geneSet <- "KEGG"

#setting the protein interaction network database to search to create gene interaction networks (choose from: "Biogrid", "STRING", "KEGG", "GeneMania", "IntAct", "mmu_STRING"). Starting with KEGG to be consistent with enrichment analysis choice.
pinName <- "KEGG"

#setting two algorithms to try for search optimization and to test the execution time (choose from greedy search ["GR"], simulated annealing ["SA"], and genetic algorithm ["GA"]). Starting with greedy search, since it is performs a truncated optimization to approximate active protein interaction network, but with less computational demands, since it isn't searching until finding a true optimum, like the SA method.
searchMethod <- "GR"

#input the terms that are desired to be compared. The code currently accepts two comparisons to controls, with the intent to further compare these differential gene expression profiles.
comparison1 <- "FEvsFC"
comparison2 <- "MEvsMC"

#loading dataset----
#Muscle tissue differential gene expression data from the following article as a downloadable excel file in the xlsx format: https://www.sciencedirect.com/science/article/pii/S2211124720307890#abs0015

#insert path to file
path <- "C:/Users/Erik/OneDrive - University of Guelph/Documents/BINF/enduranceTrainingDEG.xlsx"

#the data is being read into R with the readxl package. lapply is used to load every sheet in the excel file.
DEGlist <- lapply(excel_sheets(path), read_excel, path = path)

#check
class(DEGlist)

#finding sheet names. Help: https://readxl.tidyverse.org/reference/excel_sheets.html
sheetNames <- excel_sheets(path)

#renaming sheet names in list
names(DEGlist) <- sheetNames

#check
names(DEGlist)

#combining all comparisons into one data frame to make it easier to create multiple figures in one grid using facet wrap, and for other downstream processing.
allDEGcomparisons <- rbindlist(DEGlist, idcol = "comparison")

#checking that all group comparisons are in the new data frame
unique(allDEGcomparisons$comparison)
view(allDEGcomparisons)

#adding negative log10 p-values for downstream analysis
allDEGcomparisons$negLogP <- -log10(allDEGcomparisons$`P-Adjusted`)

#checking that column was added and that values are correct
names(allDEGcomparisons)
all.equal(allDEGcomparisons$negLogP, -log10(allDEGcomparisons$`P-Adjusted`))


#selecting variables to set up format for pathfindR downstream
selectForPathfindR <- function (x) {
  x %>%
    select(gene_name, Log2FoldChange, `P-Adjusted`)
}

DEGlistPathfindR <- lapply(DEGlist, selectForPathfindR)

#check that column names are as expected
lapply(DEGlistPathfindR, function(x) {names(x)})


#exploring data----

#creating function to explore data in every element of the list
explore <- function(x) {
  class = class(x)
  names = names(x)
  dimensions = dim(x)
  return(list(class = class, names = names, dimensions = dimensions))
}

lapply(DEGlist, explore)

#creating function to better understand the data values
dataStats <- function(x) {
  pValStats = summary(x$'P-Adjusted')
  FCstats = summary(x$'Log2FoldChange')
  numGeneNames = length(unique(x$'gene_name'))
  directions = table(x$'Direction')
  return(list("P Value Stats" = pValStats, "Fold Change Stats" = FCstats, "Number of Unique Genes" = numGeneNames, "Change Directions" = directions))
}

lapply(DEGlist, dataStats)

#checking to see if there are the same number of unique gene names as gene names overall for each list element. If so, these can serve as the unique identifiers for each element in each list, although still not overall, since there are some of the same gene names for each sample comparison
lapply(DEGlist, function(x) {length(x$gene_name) == length(unique(x$gene_name))})


#advice for quality checking for differential gene expression analysis: https://physiology.med.cornell.edu/faculty/skrabanek/lab/angsd/lecture_notes/08_practical_DE.pdf

#help with facetwrap:http://zevross.com/blog/2019/04/02/easy-multi-panel-plots-in-r-using-facet_wrap-and-facet_grid-from-ggplot2/

#plotting histogram of p-values for all comparisons with color to identify which are up- or down-regulated. Any comparisons with only up- or down-regulated genes are likely to not be of high quality.
GGhist <- ggplot(allDEGcomparisons, aes(`P-Adjusted`, fill = Direction))
GGhist +
  geom_histogram(binwidth = 0.001, col = I("grey10")) +
  labs(y = "Number of Differentially Expressed Genes", x = "Adjusted P-Value") +
  theme_classic() +
  facet_wrap(~allDEGcomparisons$comparison) +
  scale_fill_viridis_d(option = "D")


#creating volcano plots to visualize significantly differentially expressed genes with high significance

#enhanced volcano plot vignette: https://bioconductor.org/packages/devel/bioc/vignettes/EnhancedVolcano/inst/doc/EnhancedVolcano.html

#creating a function for the volcano plot, to visualize significantly differentially expressed genes with high significance. Formatting is adjusted to fit in the Rmarkdown output.
volcanoPlot <- function(data, title) {EnhancedVolcano(data,
                lab = data$gene_name,
                x = 'Log2FoldChange',
                y = 'P-Adjusted',
                title = title,
                titleLabSize = 12,
                legendLabSize = 12,
                legendIconSize = 6,
                axisLabSize = 12,
                legendPosition = "top",
                pCutoff = pCutoff,
                FCcutoff = FCcutoff,
                pointSize = 3,
                labSize = 4,
                boxedLabels = TRUE,
                drawConnectors = TRUE,
                gridlines.minor = FALSE)}

#plotting result for each comparison.
p1 <- volcanoPlot(DEGlist$FEvsFC, "FE vs FC")
p2 <- volcanoPlot(DEGlist$MEvsMC, "ME vs MC")
p3 <- volcanoPlot(DEGlist$MCvsFC, "MC vs FC")
p4 <- volcanoPlot(DEGlist$MSvsME, "MS vs ME")
p5 <- volcanoPlot(DEGlist$MEvsFE, "ME vs FE")
p6 <- volcanoPlot(DEGlist$MSvsMC, "MS vs MC")

#arranging selected figures into a grid
grid.arrange(p1, p2, p5, p3, ncol = 2)

#converting to data frame for all comparisons, which is an essential class structure to be able to run downstream pathfindR analysis
DEGlistPathfindR <- lapply(DEGlistPathfindR, function (x) {as.data.frame(x)})

#check
lapply(DEGlistPathfindR, function (x) {class(x)})


```

#Part 2:

```{r, Part2, fig.height=30}
#create functional annotation ---- using pathfindR: https://pubmed.ncbi.nlm.nih.gov/31608109/

#start with a plot of pathways, significance, etc.
#then a network
#then potentially a heatmap

#full tutorial: https://cran.r-project.org/web/packages/pathfindR/vignettes/intro_vignette.html

#turning off scientific notation to match pathway analysis format
options(scipen = 999)

#check that values are not in scientific notation
summary(DEGlistPathfindR$FEvsFC$`P-Adjusted`)

#creating function for running pathfindR, which will be used more than once downstream. Not plotting the enrichment chart, so that it can be plotted separately later.
pathfindR <- function(data) {run_pathfindR(data,
  adj_method = adjMethod,
  gene_sets = geneSet,
  pin_name_path = pinName,
  search_method = "GS",
  plot_enrichment_chart = FALSE)}

#creating custom function for selecting key outputs of interest: clustering pathway enrichment with agglomerative hierarchical clustering and plotting the enriched terms as well as the gene interaction networks for each comparison.
enrichAnalysis <- function(data) {
  result <- run_pathfindR(data)
  clusteredEnrichment <- cluster_enriched_terms(result, plot_clusters_graph = FALSE)
  termGeneGraph <- term_gene_graph(result, use_description = TRUE)
  return(list("result" = result, "enrichment" = clusteredEnrichment, "termPlot" = termGeneGraph))
}

#creating pre-specified search list
df1 <- DEGlistPathfindR[[comparison1]]
df2 <- DEGlistPathfindR[[comparison2]]
inputList <- list(df1, df2)
remove(df1, df2)

#checking that the list contains two data frames
class(inputList)
length(inputList)
class(inputList[[1]])
view(inputList[[1]])

#running analysis function through pre-selected comparisons
combinedResult <- lapply(inputList, enrichAnalysis)

#viewing tabular results
view(combinedResult[[1]]$result)
view(combinedResult[[1]]$enrichment)

#plotting a subset of samples with fold enrichment >2 and only the representative clusters, to simplify figure.
selectedClusters1 <- subset(combinedResult[[1]]$enrichment, Status %in% "Representative" & Fold_Enrichment > 2)

selectedClusters2 <- subset(combinedResult[[2]]$enrichment, Status %in% "Representative" & Fold_Enrichment > 2)

#checking that subsetting was performed
unique(selectedClusters$Status)
```

```{r, plots, fig.dim=c(14,25)}
#plotting enrichment analysis
e1 <- enrichment_chart(selectedClusters1, plot_by_cluster = TRUE, top_terms = NULL)
e2 <- enrichment_chart(selectedClusters2, plot_by_cluster = TRUE, top_terms = NULL)
grid.arrange(e1,e2)

?enrichment_chart

#performing comparison between results and looking at what fields are available
resultComparison <- combine_pathfindR_results(result_A = combinedResult[[1]]$result, result_B = combinedResult[[2]]$result, plot_common = FALSE)
names(resultComparison)

#graphing combined gene-network results. Adding full descriptive terms to nodes and sizing according to number of significant genes in the term.
combined_results_graph(resultComparison, use_description = TRUE)
```
